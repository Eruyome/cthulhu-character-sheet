!function(){"use strict";function e(e,a,t){e.otherwise("/"),a.html5Mode({enabled:!1,requireBase:!1}),a.hashPrefix("!"),t.setStorageType("localStorage"),t.setPrefix("cthulhuCharacter")}function a(){FastClick.attach(document.body)}var t=angular.module("application",["ui.router","ngAnimate","ui.bootstrap","ngFileUpload","LocalStorageModule","foundation","foundation.dynamicRouting","foundation.dynamicRouting.animations"]).config(e).run(a);e.$inject=["$urlRouterProvider","$locationProvider","localStorageServiceProvider"],t.controller("characterController",["$scope","$http","Upload","$timeout","$location","$window","localStorageService",function(e,a,t,l,i,n,c){function o(a){var t=1,l=6,i="+",n="";return a>=2&&12>=a?i="-":a>=13&&16>=a?(i="-",l=4):a>=17&&24>=a?(t=0,l=0):a>=25&&32>=a?l=4:a>=33&&40>=a||(a>=41&&56>=a?t=2:a>=57&&72>=a?t=3:a>=73&&88>=a?t=4:a>=89&&(t=5)),n=i+t,l>0&&(n+="D"+l),e.constructedDamageBonus.dmg_dice=t,e.constructedDamageBonus.dmg_diceType=l,e.constructedDamageBonus.dmg_operator=i,e.constructedDamageBonus.dmg_display=n,n}function r(a){Object.keys(a).forEach(function(t,l){for(var i,n,c,o,r=a[t].length,s=0;r>=s;s++)try{if("undefined"!=typeof a[t][s].calc){i=a[t][s].calc.stat,n=a[t][s].calc.operator,c=a[t][s].calc.modifier,"string"==typeof a[t][s].calc.modifier&&(c=e.data.player.stats_base[c].value),o=e.data.player.stats_base[i].value;var u=_[n](o,c);a[t][s].value_calc=99>u?u:99}e.calculateSkillTotal(a[t][s])}catch(d){}})}function s(e){for(var a=0,t=0;t<e.dmg_modifier.length&&!(a>0);t++)a="number"==typeof e.dmg_modifier[t]?e.dmg_modifier[t]:0;return a}function u(t){a.get(t).then(function(a){e.data=a.data,d()})}function d(){Object.keys(e.data.player.stats_base).forEach(function(a,t){e.calculateDependencies(a,e.data.player.stats_base[a])})}function m(){var a=p("data");v(a)?u("./assets/json/data.json"):e.data=a}function f(e,a){return c.set(e,a)}function p(e){return c.get(e)}function v(e){if(null==e)return!0;if(e.length>0)return!1;if(0===e.length)return!0;for(var a in e)if(hasOwnProperty.call(e,a))return!1}function g(e,a){return a?e:!e}function h(e,a){return Math.floor(Math.random()*(a-e+1))+e}e.data={},e.currentTab=0,e.armourRating=0,e.selectedItemList={},e.selectedItemListTime="anytime",e.showRemovable=!0,e.diceRollResult={},e.tempDiceResults=[],e.constructedDamageBonus={dmg_dice:0,dmg_diceType:0,dmg_operator:"",dmg_display:""};var _={"+":function(e,a){return e+a},"*":function(e,a){return e*a},"/":function(e,a){return e/a},"-":function(e,a){return e-a}};m(),e.onClickTab=function(a){e.currentTab=a},e.isActiveTab=function(a){return a==e.currentTab},e.getLength=function(e,a){try{var t=Math.ceil(e.abilities.common.length/2);return e.abilities.common.length%2&&(t-=a),t}catch(l){console.info("Data not ready yet.")}},e.calculateDependencies=function(a,t){var l=0;if(r(e.data.abilities),"str"==a||"siz"==a){l=e.data.player.stats_base.str.value+e.data.player.stats_base.siz.value;e.data.player.stats_calc.dmg_bonus.value=o(l)}"con"!=a&&"siz"!=a||(l=e.data.player.stats_base.con.value+e.data.player.stats_base.siz.value,l>0&&(e.data.player.stats_calc.hp_max.value=Math.ceil(l/2),e.isUndefined(e.data.player.stats_calc.hp.value)&&(e.data.player.stats_calc.hp.value=Math.ceil(l/2)),e.reducePointsIfHigherThanMaxValue("hp","hp_max"))),"pow"==a&&(l=5*t.value<99?5*t.value:99,e.calculateMaxSanity(),e.isUndefined(e.data.player.stats_calc.san.value)&&(e.data.player.stats_calc.san.value=l),e.reducePointsIfHigherThanMaxValue("san","san_max"),l=5*t.value<99?5*t.value:99,e.data.player.stats_calc.luck.value=l,e.data.player.stats_calc.magic_max.value=t.value,e.isUndefined(e.data.player.stats_calc.magic.value)&&(e.data.player.stats_calc.magic.value=t.value),e.isUndefined(e.data.player.stats_calc.magic.value)&&(e.data.player.stats_calc.magic.value=l),e.reducePointsIfHigherThanMaxValue("magic","magic_max")),"int"==a&&(l=5*t.value<99?5*t.value:99,e.data.player.stats_calc.idea.value=l),"edu"==a&&(l=5*t.value<99?5*t.value:99,e.data.player.stats_calc.know.value=l),"dex"==a&&(l=Math.round(.3*t.value*100)/100,e.data.player.stats_calc.range.value=l+"m")},e.calculateSkillTotal=function(a){a.value_total=a.value_base,e.isUndefined(a.value_added)||(a.value_total+=a.value_added),e.isUndefined(a.value_calc)||(a.value_total+=a.value_calc)},e.reducePointsIfHigherThanMaxValue=function(a,t){e.data.player.stats_calc[a].value>e.data.player.stats_calc[t].value&&(e.data.player.stats_calc[a].value=e.data.player.stats_calc[t].value)},e.calculateMaxSanity=function(){for(var a=0;a<e.data.abilities.common.length;a++){if(!e.isUndefined(e.data.abilities.common[a].cthulhu_mythos)){e.data.player.stats_calc.san_max.value=99-e.data.abilities.common[a].value_added,e.reducePointsIfHigherThanMaxValue("san","san_max");break}e.data.player.stats_calc.san_max.value=99}},e.calculateDamageRolls=function(a){for(var t=[],l=0;l<a.dmg_modifier.length;l++)if(a.dmg_modifier[l].toString().indexOf("dmgb")>=0){var i={dmg_dice:0,dmg_diceType:0,dmg_operator:"",dmg_modifier:[0],dmg_flat:0,dmgb_multiplier:1};e.constructedDamageBonus.dmg_diceType==a.dmg_diceType&&e.isUndefined(a.dmgb_multiplier)?(i.dmg_dice=e.constructedDamageBonus.dmg_dice+a.dmg_dice,i.dmg_diceType=a.dmg_diceType,i.dmg_operator=a.dmg_operator,i.dmg_flat=s(a),t.push(i)):(i.dmg_dice=e.constructedDamageBonus.dmg_dice+a.dmg_dice,i.dmg_diceType=a.dmg_diceType,i.dmg_operator=a.dmg_operator,i.dmg_flat=s(a),t.push(i));for(var n=0;n<a.dmg_modifier.length;n++);}},e.getStatus=function(e,a,t){var l="";return"magic"==e?l=t>=a&&1>t?"unconscious":"normal":"hitpoints"==e?l=t>=a+1&&1>t?"unconscious":t==a?"dead":"normal":"sanity"==e&&(l=t>=a&&1>t?"hopelessly insane":"normal"),l},e.validTimePeriod=function(e,a,t){return a="not"!=a,"undefined"==typeof e?!0:"anytime"===e?!0:!("anytime"!=t&&!g(e==t,a))},e.changeLanguage=function(){"English"==e.data.options.languageSelect.value?e.data.options.languageIndex=0:"Deutsch"==e.data.options.languageSelect.value&&(e.data.options.languageIndex=1)},e.addCustomAbility=function(){var a={name:[],value_added:0,value_total:0,skilled:!1,custom_name:""};e.data.abilities.custom.push(a)},e.removeCustomAbility=function(){for(var a=0;a<e.data.abilities.custom.length;a++)console.log(e.data.abilities.custom[a].custom_name),""===e.data.abilities.custom[a].custom_name&&e.data.abilities.custom.splice(a,1)},e.handleSkillChanges=function(a){e.calculateMaxSanity(),e.checkAvailableSkillPoints(),e.calculateSkillTotal(a)},e.checkAvailableSkillPoints=function(){var a=e.data.abilities,t=0;Object.keys(e.data.abilities).forEach(function(l,i){for(var n=0;n<a[l].length;n++)e.isUndefined(a[l][n].value_added)||(t+=a[l][n].value_added)}),e.data.player.skillPoints_used=t},e.playerHasArmour=function(){var a=0;try{for(var t=0;t<e.data.player.items.armour.length;t++)a+=e.data.player.items.armour[t].value;e.armourRating=a}catch(l){}return a>0},e.getWeaponSubTypeSkillChance=function(a){var t=a.sub_type,l=e.data.abilities,i=0;return Object.keys(e.data.abilities).forEach(function(e,a){for(var n=0;n<l[e].length;n++)if("custom"!=e){var c=l[e][n].sub_type;c==t&&(i=l[e][n].value_base+l[e][n].value_added,l[e][n].value_total=i)}}),i>0?i:a.value_base},e.synchSuccessStates=function(a,t,l){if("undefined"!=typeof t&&"armour"!=t){var i=e.data.abilities,n=e.data.player.items.equipped,c=[],o=0;Object.keys(n).forEach(function(e,a){for(var l=0;l<n[e].length;l++)n[e][l].sub_type==t&&c.push(n[e][l])}),Object.keys(i).forEach(function(e,n){for(var r=0;r<i[e].length;r++)if("custom"!=e){var s=i[e][r].sub_type;if(s==t){if(i[e][r].success)for(o=0;o<c.length;o++)c[o].success=i[e][r].success;if(!l&&a){for(o=0;o<c.length;o++)c[o].success=!0;i[e][r].success=!0}if(l)for(o=0;o<c.length;o++)c[o].success=i[e][r].success}}})}},e.selectItemGroup=function(){var a=e.data.options.itemSelect,t=a.options.indexOf(a.value),l=a.types[t],i={};i[l]=e.data.player.items.available[l],e.selectedItemList=i},e.resetItemSelect=function(){e.data.options.itemSelect.value="",e.selectedItemListTime="anytime",e.showRemovable=!0},e.hasRemovables=function(a){for(var t=a.length,l=0;t>l;l++)if(!e.isUndefined(a[l].removable)&&!a[l].removable)return!1;return 0!==t},e.addNewItems=function(){var a=e.data.player.items.available;Object.keys(a).forEach(function(t,l){for(var i=0;i<a[t].length;i++)a[t][i].remove&&(e.data.player.items.equipped[t].push(a[t][i]),a[t][i].remove=!1)})},e.removeItems=function(){var a=e.data.player.items.equipped;Object.keys(a).forEach(function(t,l){for(var i=0;i<a[t].length;i++)a[t][i].remove&&e.data.player.items.equipped[t].splice(i,1)})},e.rollDice=function(a,t){var l=h(1,100);if(e.diceRollResult={rollType:"",rollTypeText:"",chance:0,roll:0,diceType:0,name:"",resultText:"",dmg:0,success:!1,ability:a,canRollDamage:!1,weapon:{},isCrit:!1},e.isUndefined(a.equip)||(e.diceRollResult.canRollDamage=!0,e.diceRollResult.weapon=a),"skillCheck"==t){if(e.isUndefined(a.sub_type))e.diceRollResult.chance=a.value_total;else if("melee"==a.sub_type)e.diceRollResult.chance=a.value_base;else{var i=e.data.abilities;Object.keys(i).forEach(function(e,t){for(var l=0;l<i[e].length;l++)if(i[e][l].sub_type==a.sub_type){a=i[e][l];break}}),e.diceRollResult.chance=a.value_total}e.diceRollResult.rollTypeText="Skill-Check",e.diceRollResult.rollType="skillCheck",e.diceRollResult.name=a.name[e.data.options.languageIndex],e.diceRollResult.roll=l,l>e.diceRollResult.chance?l>=96?e.diceRollResult.resultText="Critical Fail (Roll >= 96).":e.diceRollResult.resultText="Fail.":(1==l?(e.diceRollResult.resultText="Critical Success (Roll == 1).",e.diceRollResult.isCrit=!0):l<=Math.ceil(.2*e.diceRollResult.chance)?(e.diceRollResult.resultText="Extreme Success (Roll <= 1/5 of Ability).",e.diceRollResult.isCrit=!0):l<=Math.ceil(.5*e.diceRollResult.chance)?e.diceRollResult.resultText="Difficult Success (Roll <= 1/2 of Ability).":e.diceRollResult.resultText="Success.",a.success=!0,e.diceRollResult.success=!0)}e.diceRollResult.canRollDamage&&!e.isUndefined(e.diceRollResult.weapon.malfunction)&&e.diceRollResult.weapon.malfunction<=e.diceRollResult.roll&&(e.diceRollResult.weapon.hasMalfunction=!0)},e.rollCustomDice=function(a,t){var l=[];e.tempDiceResults=[];for(var i=0;a>=i;i++)l.push(h(1,t));e.tempDiceResults=l},e.uploadFiles=function(l,i){if(e.f=l,e.errFile=i&&i[0],l){t.dataUrl(l,!1).then(function(t){a.get(t).success(function(a){e.data=a})})}},e.resetCharacter=function(){var t=i.host()+"/assets/json/data.json";a.get(t).success(function(a){e.data=a})},e.saveDataToJSON=function(e,a){if(!e)return void console.error("No data");a||(a="character"),a=a.toLowerCase().replace(/ /g,"_"),a=a.replace(/\W/g,"")+".json","object"==typeof e&&(e=JSON.stringify(e,void 0,2));var t=new Blob([e],{type:"text/json"}),l=document.createEvent("MouseEvents"),i=document.createElement("a");i.download=a,i.href=window.URL.createObjectURL(t),i.dataset.downloadurl=["text/json",i.download,i.href].join(":"),l.initEvent("click",!0,!1,window,0,0,0,0,0,!1,!1,!1,!1,0,null),i.dispatchEvent(l)},e.$watch("data",function(a,t){f("data",e.data)},!0),e.isUndefined=function(e){return"undefined"==typeof e},e.isEmpty=function(e){return e.length},e.calculateColspan=function(e){var a=0;return e&&a++,a},e.range=function(e,a,t){for(var l=[],i=t;e+a>i;i++)l.push(i);return l},e.isMaxStatValue=function(e){return e.indexOf("_max")<1},e.isVariableStat=function(e){switch(e){case"hp":return!0;case"san":return!0;case"magic":return!0}}}]),t.filter("max99",[function(){return function(e){return 99>e?e:99}}]),t.directive("sheet",function(){return{restrict:"A",templateUrl:"templates/directives/sheet.html",scope:!0}}),t.directive("info",function(){return{restrict:"A",templateUrl:"templates/directives/info.html",scope:!0}}),t.directive("ability",function(){return{restrict:"A",templateUrl:"templates/directives/ability.html",scope:!0,replace:!0}}),t.directive("weapontable",function(){return{restrict:"A",templateUrl:"templates/directives/weaponTable.html",scope:!0,replace:!0}}),t.directive("weapontableavailable",function(){return{restrict:"A",templateUrl:"templates/directives/weaponTableAvailable.html",scope:!0,replace:!0}}),t.directive("armourtable",function(){return{restrict:"A",templateUrl:"templates/directives/armourtable.html",scope:!0,replace:!0}}),t.directive("armourtableremove",function(){return{restrict:"A",templateUrl:"templates/directives/armourtableremove.html",scope:!0,replace:!0}})}();